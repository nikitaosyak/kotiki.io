<!DOCTYPE html>
<!--suppress HtmlUnknownTarget -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width,minimum-scale=1,maximum-scale=1,initial-scale=1,user-scalable=no">
    <title>kotiki.io</title>
    <script src="nakama-js.umd.js"></script>
</head>
<body>

<!--<script src="bundle.js"></script>-->
<script>
    let currentSession = null
    const errorHandler = err => console.error(err)
    const client = new nakamajs.Client()

    const sessionHandler = session => {
        console.log('sessionHandler:')
        currentSession = session
        client.connect(session).then(session => {
            localStorage.nakamaToken = session.token_
            console.log('    valid until: ', new Date(session.expiresAt))
        }).catch(errorHandler)
    }

    const restoreSession = () => {
        console.log('restoreSession:')
        let sessionString = localStorage.nakamaToken
        if (sessionString === 'undefined' || sessionString === '') {
            console.log('restoreSession: no saved session key in local storage')
            return
        }

        const session = nakamajs.Session.restore(sessionString)
        if (session.isexpired(Date.now())) {
            console.log('    session expired')
            return
        }

        console.log('    success')
        sessionHandler(session)
    }

    const loginOrRegister = () => {
        console.log('loginOrRegister:')
        const msg = nakamajs.AuthenticateRequest.email('test@test.com', '12345678')
        client.login(msg).then(sessionHandler).catch(err => {
            if (err.code === 5) {
                console.log(`    registering user`)
                client.register(msg).then(sessionHandler).catch(errorHandler)
            } else {
                console.log(`    session error: ${err.code}`)
                errorHandler(err)
            }
        })
    }

    restoreSession()
    if (currentSession === null) {
        loginOrRegister()
    }


</script>


</body>
</html>